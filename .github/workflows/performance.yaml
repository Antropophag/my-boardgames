name: Performance test

on:
  pull_request_target:

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  performance:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install playwright tabulate
          playwright install

      - name: Fetch main branch for baseline
        run: |
          git fetch origin main
          mkdir ../baseline
          git checkout origin/main
          cp -r * ../baseline

      - name: Checkout PR branch
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Start servers
        run: |
          # PR branch on port 8000
          python -m http.server 8000 &
          PID_PR=$!

          # Baseline branch on port 8001
          cd ../baseline
          python -m http.server 8001 &
          PID_BASE=$!

          # wait a few seconds to make sure servers are up
          sleep 5

          cd -  # back to PR directory

          # Run performance test
          python perf_test.py > results.txt
          cat results.txt

          # Kill servers
          kill $PID_PR
          kill $PID_BASE

      - name: Save results as artifact
        uses: actions/upload-artifact@v6
        with:
          name: perf-results
          path: results.txt

      - name: Check GH_TOKEN
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          if [ -z "$GH_TOKEN" ]; then
            echo "❌ GH_TOKEN is empty"
            exit 1
          else
            echo "✅ GH_TOKEN ok, length: ${#GH_TOKEN}"
          fi

      - name: Post results to PR
        uses: peter-evans/create-or-update-comment@v5
        with:
          token: ${{ secrets.GH_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### Performance comparison
            ```
            $(cat results.txt)
            ```

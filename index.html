<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Play with me</title>

<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="stylesheet" href="fonts/foundation-icons.css">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">

<style>
/* CSS оставляем как в твоей версии, включая .game, Masonry, лоадер и т.д. */
</style>
</head>
<body>

<div id="loader">
  <img src="dice.gif" alt="loading" class="loader-gif">
</div>

<div id="ownMosaic" class="mosaic"></div>
<h2 class="section-title">Pre-ordered</h2>
<div id="preMosaic" class="mosaic"></div>
<h2 class="section-title">Wishlist</h2>
<div id="wishMosaic" class="mosaic"></div>

<script src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
<script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {

  const loader = document.getElementById('loader');

  // Максимум 3 сек на лоадер
  setTimeout(() => { if(loader) loader.style.display='none'; }, 3000);

  function getRatingColor(avg){
    if(avg>=8) return '#186b40';
    if(avg>=7) return '#1978b3';
    if(avg>=5) return '#5369a2';
    return '#666e75';
  }

  function createGameDiv(game){
    const div = document.createElement('div');
    div.className = 'game';

    const ratingColor = getRatingColor(game.average);
    let weightColor = '#5bda98';
    if(game.averageweight>4) weightColor='#df4751';
    else if(game.averageweight>3) weightColor='#ff6b26';

    const rank = game.overallrank ?? '—';

    const proxiedBase = `https://images.weserv.nl/?url=${encodeURIComponent(game.image)}`;
    const srcset = `
      ${proxiedBase}&w=400&output=webp 400w,
      ${proxiedBase}&w=800&output=webp 800w,
      ${proxiedBase}&w=1200&output=webp 1200w
    `;

    div.innerHTML = `
      <img 
        src="${proxiedBase}&w=800&output=webp" 
        srcset="${srcset}"
        sizes="(max-width: 600px) 100vw, (max-width: 1200px) 50vw, 800px"
        alt="${game.name}" 
        loading="lazy"
        onerror="this.src='${game.image}'">
      <div class="overlay">
        <div class="overlay-content">
          <div class="rating-hex" style="background-color:${ratingColor}">${game.average.toFixed(1)}</div>
          <div class="title-rank">
            <div class="title"><a href="${game.url}" target="_blank">${game.name}</a></div>
            <div class="rank"><i class="fi-crown"></i> ${rank}</div>
          </div>
        </div>
        <div class="info">
          <p><i class="fi-torso"></i> ${game.minplayers}–${game.maxplayers}</p>
          <p><i class="fi-clock"></i> ${game.playingtime} min</p>
          <p><i class="fi-puzzle"></i> <span style="color:${weightColor}">${game.averageweight !== null ? game.averageweight.toFixed(2) : 'N/A'}</span> / 5</p>
        </div>
        <div class="info-column">
          <p>Players: ${game.minplayers}–${game.maxplayers}</p>
          <p>Playing time: ${game.playingtime} min</p>
          <p>Complexity: <span style="color:${weightColor}">${game.averageweight !== null ? game.averageweight.toFixed(2) : 'N/A'}</span> / 5</p>
        </div>
      </div>
    `;
    return div;
  }

  function getColumnCount(){
    if(window.innerWidth < 600) return 2;
    if(window.innerWidth < 900) return 3;
    if(window.innerWidth < 1200) return 4;
    return 3; // шире карточки на больших экранах
  }

  function layoutMasonry(container){
    const colCount = getColumnCount();
    const colWidth = container.clientWidth / colCount;
    container.querySelectorAll('.game').forEach(el => el.style.width = colWidth + 'px');

    return new Masonry(container, {
      itemSelector: '.game',
      columnWidth: colWidth,
      gutter: 0,
      percentPosition: false,
      transitionDuration: '0.4s'
    });
  }

  function loadGames(file, containerId){
    const container = document.getElementById(containerId);
    if(!container) return;

    fetch(file)
      .then(res => res.json())
      .then(data => {
        const games = data[containerId==='ownMosaic'?'own':containerId==='preMosaic'?'preordered':'wishlist'];
        games.forEach(game => container.appendChild(createGameDiv(game)));

        imagesLoaded(container, () => {
          const msnry = layoutMasonry(container);
          container.querySelectorAll('.game').forEach((el,i)=>setTimeout(()=>el.classList.add('show'), 100*i));

          if(loader) loader.style.display='none';

          window.addEventListener('resize', () => {
            const newColWidth = container.clientWidth / getColumnCount();
            container.querySelectorAll('.game').forEach(el => el.style.width = newColWidth + 'px');
            msnry.options.columnWidth = newColWidth;
            msnry.layout();
          });
        });
      })
      .catch(err => {
        console.error('Failed to load games:', err);
        if(loader) loader.style.display='none';
      });
  }

  loadGames('data/games.json','ownMosaic');
  loadGames('data/games.json','preMosaic');
  loadGames('data/games.json','wishMosaic');

});

// Регистрация Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(reg => console.log('ServiceWorker зарегистрирован:', reg.scope))
      .catch(err => console.error('Ошибка ServiceWorker:', err));
  });
}
</script>

</body>
</html>

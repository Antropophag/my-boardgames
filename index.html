<script>
function getColumnCount() {
  if (window.innerWidth < 600) return 2;
  if (window.innerWidth < 900) return 3;
  if (window.innerWidth < 1200) return 4;
  return 5;
}

function updateColumns(container) {
  const colWidth = container.clientWidth / getColumnCount();
  container.querySelectorAll('.game').forEach(el => el.style.width = colWidth + 'px');
  return colWidth;
}

function getRatingColor(avg) {
  if(avg >= 8) return '#186b40';       
  if(avg >= 7) return '#1978b3';       
  if(avg >= 5) return '#5369a2';       
  return '#666e75';                     
}

// --- НОВОЕ: прокси через weserv.nl с fallback ---
function getWeservUrl(bggUrl) {
  const urlObj = new URL(bggUrl);
  return `https://images.weserv.nl/?url=${urlObj.hostname}${urlObj.pathname}`;
}

function getImageUrl(originalUrl) {
  const proxyUrl = getWeservUrl(originalUrl);
  const fallback = originalUrl;

  return new Promise(resolve => {
    const img = new Image();
    img.onload = () => resolve(proxyUrl);
    img.onerror = () => resolve(fallback);
    img.src = proxyUrl;
  });
}

async function createGameDiv(game) {
  const div = document.createElement('div');
  div.className = 'game';

  const imgUrl = await getImageUrl(game.image);

  const ratingColor = getRatingColor(game.average);
  let weightColor = '#5bda98';
  if(game.averageweight > 4) weightColor = '#df4751';
  else if(game.averageweight > 3) weightColor = '#ff6b26';

  const rank = game.overallrank ?? '—';

  div.innerHTML = `
    <img src="${imgUrl}" alt="${game.name}">
    <div class="overlay">
      <div class="overlay-content">
        <div class="rating-hex" style="background-color:${ratingColor}">${game.average.toFixed(1)}</div>
        <div class="title-rank">
          <div class="title"><a href="${game.url}" target="_blank">${game.name}</a></div>
          <div class="rank"><i class="fi-crown"></i> ${rank}</div>
        </div>
      </div>
      <div class="info">
        <p><i class="fi-torso"></i> ${game.minplayers}–${game.maxplayers}</p>
        <p><i class="fi-clock"></i> ${game.playingtime} min</p>
        <p><i class="fi-puzzle"></i> <span style="color:${weightColor}">${game.averageweight !== null ? game.averageweight.toFixed(2) : 'N/A'}</span> / 5</p>
      </div>
      <div class="info-column">
        <p>Players: ${game.minplayers}–${game.maxplayers}</p>
        <p>Playing time: ${game.playingtime} min</p>
        <p>Complexity: <span style="color:${weightColor}">${game.averageweight !== null ? game.averageweight.toFixed(2) : 'N/A'}</span> / 5</p>
      </div>
    </div>
  `;
  return div;
}

async function loadGamesSection(file, containerId) {
  const container = document.getElementById(containerId);
  const res = await fetch(file);
  const data = await res.json();
  const games = data[containerId === 'ownMosaic' ? 'own' : containerId === 'preMosaic' ? 'preordered' : 'wishlist'];

  for (const game of games) {
    const div = await createGameDiv(game);
    container.appendChild(div);
  }

  imagesLoaded(container, () => {
    const colWidth = updateColumns(container);
    const msnry = new Masonry(container, {
      itemSelector: '.game',
      columnWidth: colWidth,
      gutter: 0,
      percentPosition: false,
      transitionDuration: '0.4s'
    });

    container.querySelectorAll('.game').forEach((el, i) => {
      setTimeout(() => el.classList.add('show'), 100*i);
    });

    window.addEventListener('resize', () => {
      const newColWidth = container.clientWidth / getColumnCount();
      container.querySelectorAll('.game').forEach(el => el.style.width = newColWidth + 'px');
      msnry.options.columnWidth = newColWidth;
      msnry.layout();
    });
  });
}

async function loadAllSections() {
  await loadGamesSection('data/games.json', 'ownMosaic');
  document.getElementById('loader').style.display = 'none';
  await loadGamesSection('data/games.json', 'preMosaic');
  await loadGamesSection('data/games.json', 'wishMosaic');
}

loadAllSections();
</script>
